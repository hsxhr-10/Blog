## 单元测试

### 基本用法

```Python
# demo1.py
class House:
    def __init__(self, owner, worth):
        self.__owner = owner
        self.__worth = worth
        self.__peoples = []

    @property
    def owner(self):
        return self.__owner

    @owner.setter
    def owner(self, _owner):
        self.__owner = _owner

    @property
    def worth(self):
        return self.__worth

    @worth.setter
    def worth(self, _worth):
        if _worth < 0:
            return
        self.__worth = _worth

    @property
    def peoples(self):
        return self.__peoples

    @peoples.setter
    def peoples(self, name):
        if name not in self.__peoples:
            self.__peoples.append(name)
```

```Python
# demo2.py
import unittest

from demo1 import House


class HouseTestCase(unittest.TestCase):
    def setUp(self):
        self.house = House("yoko", 123456789)

    def tearDown(self):
        del self.house

    def test_0_house_owner_getter(self):
        self.assertEqual(self.house.owner, "yoko")

    def test_0_house_owner_setter(self):
        self.house.owner = "tiger"
        self.assertEqual(self.house.owner, "tiger")

    def test_0_house_worth_getter(self):
        self.assertEqual(self.house.worth, 123456789)

    def test_0_house_worth_setter(self):
        self.house.worth = 999999999
        self.assertEqual(self.house.worth, 999999999)

    def test_1_house_worth_setter(self):
        """
        测试 @worth.setter 中的分支情况.

        注意: 虽然在 test_0_house_worth_setter() 中将 self.house.worth 改成了 999999999, 
                但是每个测试案例执行前都会重新调用 setUp(),
                也就是说在 test_1_house_worth_setter() 中 self.house 仍然为 setUp() 时设定的值 123456789.
        """
        self.house.worth = -1
        self.assertEqual(self.house.worth, 123456789)

    def test_0_house_peoples_getter(self):
        self.assertEqual(self.house.peoples, [])

    def test_0_house_peoples_setter(self):
        self.house.peoples = "tiger"
        self.house.peoples = "yoko"
        self.house.peoples = "wade"
        self.house.peoples = "simon"
        self.assertEqual(self.house.peoples, ["tiger", "yoko", "wade", "simon"])


if __name__ == "__main__":
    unittest.main(verbosity=2)
```

```bash
$ python demo2.py                                                                                                                                                                                                                                                                                          
test_0_house_owner_getter (__main__.HouseTestCase) ... ok
test_0_house_owner_setter (__main__.HouseTestCase) ... ok
test_0_house_peoples_getter (__main__.HouseTestCase) ... ok
test_0_house_peoples_setter (__main__.HouseTestCase) ... ok
test_0_house_worth_getter (__main__.HouseTestCase) ... ok
test_0_house_worth_setter (__main__.HouseTestCase) ... ok
test_1_house_worth_setter (__main__.HouseTestCase) ... ok

----------------------------------------------------------------------
Ran 7 tests in 0.001s

OK
```

### 跳过某个测试案例

有时候可能只是要简单地跳过某一个测试案例，只需要在测试案例加上装饰器 `@unittest.skip("XXX")`

```Python
@unittest.skip("skipping")
def test_0_house_owner_getter(self):
    self.assertEqual(self.house.owner, "yoko")
```

### Mock

```Python
def query_mysql(self):
    # 假设这里有一些 MySQL 的查询操作, 查询出来的结果为 "some data"
    return "some data"
```

```Python
from unittest.mock import MagicMock


def setUp(self):
    self.house = House("yoko", 123456789)

    # mock 掉外部依赖的 MySQL, 返回 mock 数据 [12, 32, 43, 74, 25, 16, 77, 89, 90]
    self.house.query_mysql = MagicMock(
        return_value=[12, 32, 43, 74, 25, 16, 77, 89, 90])


def test_0_house_query_mysql(self):
    res = self.house.query_mysql()
    self.assertEqual(res, [12, 32, 43, 74, 25, 16, 77, 89, 90])
```

### Coverage

1. 安装：`pip install coverage`
2. 执行，比如上面的 `demo2.py`：`coverage run -m unittest demo2.py`
3. 执行完之后会在当前目录生成一个 `.coverage`
4. 查看覆盖率报告：`coverage report -m`
   ```Bash
   $ coverage report -m
    Name       Stmts   Miss  Cover   Missing
    ----------------------------------------
    demo1.py      22      1    95%   36
    demo2.py      35      1    97%   57
    ----------------------------------------
    TOTAL         57      2    96%
   ```
5. 有需要的可以再生成 HTML 形式的报告：`coverage html`（生成的 HTML 会在 `htmlcov`
   目录下，其中绿色代表有覆盖到的代码，红色代表没有覆盖到代码）
   ![](https://raw.githubusercontent.com/hsxhr-10/Blog/master/image/Python%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0_%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95_coverage.png)
   ![](https://raw.githubusercontent.com/hsxhr-10/Blog/master/image/Python%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0_%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95_coverage1.png)

### 参考

- [unittest 官方文档](https://docs.python.org/3/library/unittest.html#module-unittest)
- [unittest mock 官方文档](https://docs.python.org/3/library/unittest.mock.html#quick-guide)
- [coverage 官方文档](https://coverage.readthedocs.io/en/latest/#quick-start)
